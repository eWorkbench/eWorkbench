<!--
  Copyright (C) 2016-2020 TU Muenchen and contributors of ANEXIA Internetdienstleistungs GmbH
  SPDX-License-Identifier: AGPL-3.0-or-later
-->

<ng-container *transloco="let t">
  <eworkbench-modal [modalFooter]="false" [noPadding]="true">
    <div slot="header">
      {{ t('taskBoard.backlogModal.header') }}
    </div>
    <div slot="body">
      <div class="filter-sidebar">
        <div class="flex flex-col justify-between p-6">
          <div>
            <div class="flex items-center pb-4 mb-5 border-0 border-b-[3px] border-solid border-tum-border-gray">
              <div class="search-input">
                <div class="input-group search-input-group">
                  <input
                    type="text"
                    class="form-control ewb-input"
                    id="search-header"
                    name="search-header"
                    [formControl]="searchControl"
                    [placeholder]="t('taskBoard.backlogModal.filter.search.placeholder')"
                  />
                  <button type="button" class="btn btn-sm bg-transparent clear-input" *ngIf="!searchControl.value">
                    <eworkbench-icon className="wb-search"></eworkbench-icon>
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm bg-transparent clear-input"
                    (click)="searchControl.patchValue(null)"
                    *ngIf="searchControl.value"
                  >
                    <eworkbench-icon className="wb-remove"></eworkbench-icon>
                  </button>
                </div>
              </div>
            </div>

            <div class="flex justify-between pb-4 mb-5">
              <div class="space-x-2">
                <div *ngIf="!filtersChanged" class="text-sm text-tum-info-color">
                  {{ t('filterHeader.noFilters') }}
                </div>

                <div
                  *ngIf="getFilterSelectedProject"
                  class="bg-tum-primary hover:bg-tum-primary-hover text-white py-0.5 px-2.5 rounded-full inline-flex justify-between items-center"
                >
                  <span class="text-sm mr-2">{{ getFilterSelectedProject?.display }}</span>
                  <button
                    type="button"
                    class="btn ewb-button-small text-white"
                    [tooltip]="t('filterHeader.chip.tooltip.remove')"
                    containerClass="tooltip-sm"
                    (click)="projectsControl.setValue(null)"
                  >
                    <eworkbench-icon className="wb-remove"></eworkbench-icon>
                  </button>
                </div>
              </div>

              <div class="flex items-center space-x-6">
                <div class="inline-block">
                  <div class="custom-control custom-checkbox">
                    <input
                      class="custom-control-input"
                      type="checkbox"
                      [formControl]="favoritesControl"
                      id="favorites-filter"
                      name="favorites-filter"
                      [checked]="favoritesControl.value"
                    />
                    <label for="favorites-filter" class="custom-control-label font-normal leading-5">
                      {{ t('filterHeader.favorites.label') }}
                    </label>
                  </div>
                </div>

                <button
                  *ngIf="filtersChanged"
                  type="button"
                  class="btn ewb-button-regular ewb-button-additional inline-flex items-center"
                  [disabled]="!filtersChanged"
                  (click)="onResetFilters()"
                >
                  {{ t('filterHeader.resetAll') }}
                </button>
              </div>
            </div>

            <eworkbench-loading [loading]="loading">
              <eworkbench-table-view
                #tableView
                [columns]="listColumns"
                [service]="tasksBacklogService"
                [params]="params"
                [selectable]="true"
                [customId]="taskBoardId"
                (dataSelected)="onSelected($event)"
              ></eworkbench-table-view>
            </eworkbench-loading>
          </div>

          <div class="modal-footer p-0 mt-5">
            <button class="btn ewb-button-big ewb-button-secondary mr-2" (click)="modalRef.close()" [disabled]="loading">
              {{ t('taskBoard.backlogModal.close') }}
            </button>
            <!-- // TODO: translate singular and plural of tasks -->
            <button class="btn ewb-button-big ewb-button-primary" (click)="onSubmit()" [disabled]="loading || !selected.length">
              {{
                t('taskBoard.backlogModal.add', {
                  num: selected.length ? (selected.length === 1 ? selected.length + ' task' : selected.length + ' tasks') : 'task'
                })
              }}
            </button>
          </div>
        </div>

        <aside>
          <eworkbench-filter-sidebar
            [miniTop]="true"
            [activeFilters]="filtersChanged"
            [rememberFilters]="false"
            (resetFilters)="onResetFilters()"
          >
            <div>
              <label for="users-filter-backlog" class="text-base font-bold">
                {{ t('taskBoard.backlogModal.filter.createdBy.label') }}
              </label>
              <div class="mt-4">
                <div class="space-y-2">
                  <div class="custom-control custom-radio">
                    <input
                      type="radio"
                      class="custom-control-input"
                      name="filter-user-radio-backlog"
                      id="filter-user-radio-backlog-1"
                      [value]="null"
                      [formControl]="usersControl"
                      (change)="onUserFilterRadioAnyone()"
                    />
                    <label for="filter-user-radio-backlog-1" class="custom-control-label font-normal leading-6">
                      {{ t('filter-menu.anyone.label') }}
                    </label>
                  </div>
                  <div class="custom-control custom-radio">
                    <input
                      type="radio"
                      class="custom-control-input"
                      name="filter-user-radio-backlog"
                      id="filter-user-radio-backlog-2"
                      [value]="currentUser?.pk"
                      [formControl]="usersControl"
                      (change)="onUserFilterRadioMyself($event.target?.checked)"
                    />
                    <label for="filter-user-radio-backlog-2" class="custom-control-label font-normal leading-6">
                      {{ t('filter-menu.myself.label') }}
                    </label>
                  </div>
                  <div class="custom-control custom-radio">
                    <input
                      type="radio"
                      class="custom-control-input"
                      name="filter-user-radio-backlog"
                      id="filter-user-radio-backlog-3"
                      (change)="showUserFilter = $event.target?.checked"
                    />
                    <label for="filter-user-radio-backlog-3" class="custom-control-label font-normal leading-6">
                      {{ t('filter-menu.chooseAUser.label') }}
                    </label>
                  </div>
                </div>
                <div *ngIf="showUserFilter" class="mt-4">
                  <ng-select
                    #select
                    class="ewb-select"
                    [formControl]="usersControl"
                    labelForId="users-filter-backlog"
                    name="users-filter-backlog"
                    [placeholder]="t('taskBoard.backlogModal.filter.users.placeholder')"
                    [typeahead]="usersInput$"
                    [items]="users"
                    bindLabel="username"
                    bindValue="pk"
                  >
                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                      <div class="flex items-center user-option">
                        <eworkbench-user-details
                          class="inline-block mr-1"
                          [user]="item"
                          [chip]="true"
                          (click)="select.isOpen = false"
                        ></eworkbench-user-details>
                        <span class="sub-text">{{ item.email }}</span>
                      </div>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                      <div class="user-dropdown-option">
                        <img class="rounded-full mr-2" width="40" [src]="item.userprofile.avatar" [alt]="t('profile.picture')" />
                        <div>
                          <ng-container *ngIf="item?.userprofile.anonymized">
                            <span class="details text-gray-600">{{ t('user.details.anonymizedUser') }}</span>
                          </ng-container>
                          <ng-container *ngIf="!item?.userprofile.anonymized">
                            <ng-container
                              *ngIf="item?.userprofile.first_name && item?.userprofile.last_name; then userTemplate; else usernameTemplate"
                            ></ng-container>
                          </ng-container>

                          <ng-template #userTemplate>
                            <span [ngOptionHighlight]="search">{{ item?.userprofile.first_name }} {{ item?.userprofile.last_name }}</span>
                          </ng-template>
                          <ng-template #usernameTemplate>
                            <span [ngOptionHighlight]="search">{{ item?.username }}</span>
                          </ng-template>

                          <div class="sub-text" [ngOptionHighlight]="search">{{ item.email }}</div>
                        </div>
                      </div>
                    </ng-template>
                  </ng-select>
                </div>
              </div>
            </div>

            <div>
              <label for="assignees-filter-backlog" class="text-base font-bold">
                {{ t('taskBoard.backlogModal.filter.assignedUsers.label') }}
              </label>
              <div class="mt-4">
                <div class="space-y-2">
                  <div class="custom-control custom-radio">
                    <input
                      type="radio"
                      class="custom-control-input"
                      name="filter-assignee-radio-backlog"
                      id="filter-assignee-radio-backlog-1"
                      [value]="null"
                      [formControl]="assigneesControl"
                      (change)="onUserFilterRadioAnyoneAssignees()"
                    />
                    <label for="filter-assignee-radio-backlog-1" class="custom-control-label font-normal leading-6">
                      {{ t('filter-menu.anyone.label') }}
                    </label>
                  </div>
                  <div class="custom-control custom-radio">
                    <input
                      type="radio"
                      class="custom-control-input"
                      name="filter-assignee-radio-backlog"
                      id="filter-assignee-radio-backlog-2"
                      [value]="currentUser?.pk"
                      [formControl]="assigneesControl"
                      (change)="onUserFilterRadioMyselfAssignees($event.target?.checked)"
                    />
                    <label for="filter-assignee-radio-backlog-2" class="custom-control-label font-normal leading-6">
                      {{ t('filter-menu.myself.label') }}
                    </label>
                  </div>
                  <div class="custom-control custom-radio">
                    <input
                      type="radio"
                      class="custom-control-input"
                      name="filter-assignee-radio-backlog"
                      id="filter-assignee-radio-backlog-3"
                      (change)="showAssigneesFilter = $event.target?.checked"
                    />
                    <label for="filter-assignee-radio-backlog-3" class="custom-control-label font-normal leading-6">
                      {{ t('filter-menu.chooseAUser.label') }}
                    </label>
                  </div>
                </div>
                <div *ngIf="showAssigneesFilter" class="mt-4">
                  <ng-select
                    #select
                    class="ewb-select"
                    [formControl]="assigneesControl"
                    labelForId="assignees-filter-backlog"
                    name="assignees-filter-backlog"
                    [placeholder]="t('taskBoard.backlogModal.filter.users.placeholder')"
                    [typeahead]="assigneesInput$"
                    [items]="assignees"
                    bindLabel="username"
                    bindValue="pk"
                  >
                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                      <div class="flex items-center user-option">
                        <eworkbench-user-details
                          class="inline-block mr-1"
                          [user]="item"
                          [chip]="true"
                          (click)="select.isOpen = false"
                        ></eworkbench-user-details>
                        <span class="sub-text">{{ item.email }}</span>
                      </div>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                      <div class="user-dropdown-option">
                        <img class="rounded-full mr-2" width="40" [src]="item.userprofile.avatar" [alt]="t('profile.picture')" />
                        <div>
                          <ng-container *ngIf="item?.userprofile.anonymized">
                            <span class="details text-gray-600">{{ t('user.details.anonymizedUser') }}</span>
                          </ng-container>
                          <ng-container *ngIf="!item?.userprofile.anonymized">
                            <ng-container
                              *ngIf="item?.userprofile.first_name && item?.userprofile.last_name; then userTemplate; else usernameTemplate"
                            ></ng-container>
                          </ng-container>

                          <ng-template #userTemplate>
                            <span [ngOptionHighlight]="search">{{ item?.userprofile.first_name }} {{ item?.userprofile.last_name }}</span>
                          </ng-template>
                          <ng-template #usernameTemplate>
                            <span [ngOptionHighlight]="search">{{ item?.username }}</span>
                          </ng-template>

                          <div class="sub-text" [ngOptionHighlight]="search">{{ item.email }}</div>
                        </div>
                      </div>
                    </ng-template>
                  </ng-select>
                </div>
              </div>
            </div>

            <div>
              <label for="projects-filter-backlog" class="text-base font-bold">
                {{ t('taskBoard.backlogModal.filter.projectRelation.label') }}
              </label>
              <div class="mt-4">
                <ng-select
                  class="ewb-select"
                  [formControl]="projectsControl"
                  labelForId="projects-filter-backlog"
                  name="projects-filter-backlog"
                  [placeholder]="t('taskBoard.backlogModal.filter.projects.placeholder')"
                  [typeahead]="projectsInput$"
                  [items]="projects"
                  groupBy="is_favourite"
                  bindLabel="name"
                  bindValue="pk"
                >
                  <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                    <eworkbench-icon className="wb-favorite-3" class="favorite-icon" *ngIf="item.is_favourite"></eworkbench-icon>
                    <span [ngOptionHighlight]="search">{{ item.name }}</span>
                  </ng-template>
                  <ng-template ng-optgroup-tmp let-item="item">
                    <ng-container *ngIf="item.is_favourite">{{ t('formInput.select.optgroup.favorite') }}</ng-container>
                    <ng-container *ngIf="!item.is_favourite">{{ t('formInput.select.optgroup.other') }}</ng-container>
                  </ng-template>
                  <ng-template ng-notfound-tmp>
                    <div class="ng-option">{{ t('formInput.select.noMatch') }}</div>
                  </ng-template>
                </ng-select>
              </div>
            </div>

            <div>
              <label class="text-base font-bold">{{ t('taskBoard.backlogModal.filter.taskPriority.label') }}</label>
              <div class="mt-4">
                <ul class="list-unstyled">
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="very-high-prio-task-filter-backlog"
                        name="very-high-prio-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="veryHighCheckbox"
                      />
                      <label for="very-high-prio-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskPriority.veryHigh.label') }}
                      </label>
                    </div>
                  </li>
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="high-prio-task-filter-backlog"
                        name="high-prio-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="highCheckbox"
                      />
                      <label for="high-prio-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskPriority.high.label') }}
                      </label>
                    </div>
                  </li>
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="normal-task-filter-backlog"
                        name="normal-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="normalCheckbox"
                      />
                      <label for="normal-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskPriority.normal.label') }}
                      </label>
                    </div>
                  </li>
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="low-task-filter-backlog"
                        name="low-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="lowCheckbox"
                      />
                      <label for="low-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskPriority.low.label') }}
                      </label>
                    </div>
                  </li>
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="very-low-task-filter-backlog"
                        name="very-low-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="veryLowCheckbox"
                      />
                      <label for="very-low-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskPriority.veryLow.label') }}
                      </label>
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <div>
              <label class="text-base font-bold">{{ t('taskBoard.backlogModal.filter.taskState.label') }}</label>
              <div class="mt-4">
                <ul class="list-unstyled">
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="new-task-filter-backlog"
                        name="new-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="newCheckbox"
                      />
                      <label for="new-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskState.new.label') }}
                      </label>
                    </div>
                  </li>
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="progress-task-filter-backlog"
                        name="progress-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="progressCheckbox"
                      />
                      <label for="progress-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskState.inProgress.label') }}
                      </label>
                    </div>
                  </li>
                  <li>
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        id="done-task-filter-backlog"
                        name="done-task-filter-backlog"
                        class="custom-control-input"
                        [formControl]="doneCheckbox"
                      />
                      <label for="done-task-filter-backlog" class="custom-control-label font-normal leading-5">
                        {{ t('taskBoard.backlogModal.filter.filterByTaskState.done.label') }}
                      </label>
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <div>
              <label for="favorites-filter-backlog" class="text-base font-bold">
                {{ t('taskBoard.backlogModal.filter.favoriteMarker.label') }}
              </label>
              <div class="mt-4">
                <div class="custom-control custom-checkbox">
                  <input
                    class="custom-control-input"
                    type="checkbox"
                    [formControl]="favoritesControl"
                    id="favorites-filter-backlog"
                    name="favorites-filter-backlog"
                    [checked]="favoritesControl.value"
                  />
                  <label for="favorites-filter-backlog" class="custom-control-label font-normal leading-5">
                    {{ t('taskBoard.backlogModal.filter.favorites.label') }}
                  </label>
                </div>
              </div>
            </div>
          </eworkbench-filter-sidebar>
        </aside>
      </div>
    </div>
  </eworkbench-modal>
</ng-container>

<ng-template #taskIdCellTemplate let-row>
  <a [routerLink]="['/tasks', row.pk]" target="_blank">#{{ row.task_id }}</a>
</ng-template>
<ng-template #priorityCellTemplate let-row>
  <eworkbench-task-priority [priority]="row.priority"></eworkbench-task-priority>
</ng-template>
<ng-template #titleCellTemplate let-row>
  <div ellipsis="300" [tooltip]="row.title" containerClass="tooltip-sm" [delay]="500">
    <a [routerLink]="['/tasks', row.pk]" target="_blank">{{ row.title }}</a>
  </div>
</ng-template>
<ng-template #stateCellTemplate let-row>
  <eworkbench-task-state [state]="row.state"></eworkbench-task-state>
</ng-template>
<ng-template #startDateCellTemplate let-row>
  {{ row.start_date | formatDate }}
</ng-template>
<ng-template #dueDateCellTemplate let-row>
  {{ row.due_date | formatDate }}
</ng-template>
<ng-template #assigneesCellTemplate let-row>
  <eworkbench-users-grouping [users]="row.assigned_users" [chip]="true" [modal]="false"></eworkbench-users-grouping>
</ng-template>
<ng-template #actionsCellTemplate let-row>
  <div class="text-right">
    <eworkbench-favorite-button
      *ngIf="!row.deleted"
      class="inline-block"
      [id]="row.pk"
      [contentType]="row.content_type"
      [favorited]="row.is_favourite"
    ></eworkbench-favorite-button>
  </div>
</ng-template>
