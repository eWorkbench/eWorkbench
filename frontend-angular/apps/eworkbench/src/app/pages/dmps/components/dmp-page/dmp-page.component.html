<!--
  Copyright (C) 2016-2020 TU Muenchen and contributors of ANEXIA Internetdienstleistungs GmbH
  SPDX-License-Identifier: AGPL-3.0-or-later
-->

<ng-container *transloco="let t">
  <eworkbench-header [title]="detailsTitle">
    <ng-container slot="elements" *ngIf="initialState">
      <eworkbench-favorite-button
        class="inline-block mr-2"
        [id]="initialState?.pk"
        [contentType]="initialState?.content_type"
        [favorited]="initialState?.is_favourite"
        btnClass="btn bg-transparent ewb-button-big square-md text-white"
      ></eworkbench-favorite-button>
      <eworkbench-details-dropdown
        [service]="dmpService"
        [id]="id"
        [redirectDestination]="[showSidebar ? '.' : '' + '/dmps', id]"
        [newModalComponent]="newModalComponent"
        [initialState]="initialState"
        [privileges]="privileges"
        *ngIf="privileges"
      ></eworkbench-details-dropdown>
    </ng-container>
  </eworkbench-header>
</ng-container>

<div *ngIf="!initialState" [class.with-sidebar]="showSidebar">
  <aside *ngIf="showSidebar">
    <eworkbench-sidebar-skeleton></eworkbench-sidebar-skeleton>
  </aside>
  <div class="skeleton-wrapper">
    <eworkbench-list-skeleton [lines]="0" [header]="true"></eworkbench-list-skeleton>
    <eworkbench-list-skeleton [header]="true"></eworkbench-list-skeleton>
  </div>
</div>

<ng-container *ngIf="initialState">
  <ng-container *transloco="let t">
    <div [class.with-sidebar]="showSidebar">
      <aside *ngIf="showSidebar">
        <eworkbench-project-sidebar [sidebarItem]="sidebarItem"></eworkbench-project-sidebar>
      </aside>
      <main>
        <ng-container *ngIf="initialState?.deleted">
          <eworkbench-trash-notice></eworkbench-trash-notice>
        </ng-container>

        <eworkbench-lock [id]="id" [lock]="lock" [lockUser]="lockUser" [modified]="modified" [service]="dmpService"></eworkbench-lock>
        <form [formGroup]="form" (ngSubmit)="onSubmit()" errorTailor>
          <eworkbench-overview-collapse-element class="mb-4" [collapsed]="true">
            <div class="dmp">
              <div>
                <eworkbench-details-collapse-element [labelText]="t('dmp.details.element.details')">
                  <ng-container slot="body">
                    <div class="mb-4">
                      <eworkbench-form-input
                        for="title"
                        [label]="t('dmp.details.title.label')"
                        [loading]="loading"
                        [onSubmit]="refreshResetValue"
                      >
                        <input
                          type="text"
                          class="form-control ewb-input"
                          id="title"
                          formControlName="title"
                          name="title"
                          [placeholder]="t('dmp.details.title.placeholder')"
                          slot="input"
                        />
                      </eworkbench-form-input>
                    </div>
                    <div class="mb-4">
                      <label for="template">
                        {{ t('dmp.details.dmpTemplate.placeholder') }}
                        <eworkbench-icon
                          className="wb-info"
                          class="cursor-help"
                          [tooltip]="t('dmp.details.dmpTemplate.tooltip')"
                          container="body"
                          containerClass="tooltip-sm"
                        ></eworkbench-icon>
                      </label>
                      <div>{{ initialState?.dmp_form_title }}</div>
                    </div>
                    <div class="mb-4">
                      <eworkbench-form-input [loading]="loading" [onSubmit]="refreshResetValue" [required]="true">
                        <label for="status" slot="label">
                          {{ t('dmp.details.status.label') }}
                          <eworkbench-form-asterisk class="inline-block"></eworkbench-form-asterisk>
                          <eworkbench-icon
                            className="wb-info"
                            class="ml-1 cursor-help"
                            [tooltip]="t('dmp.details.status.tooltip')"
                            container="body"
                            containerClass="tooltip-sm"
                          ></eworkbench-icon>
                        </label>
                        <ng-select
                          class="ewb-select"
                          formControlName="status"
                          labelForId="status"
                          name="status"
                          [placeholder]="t('dmp.details.status.placeholder')"
                          [items]="status"
                          bindLabel="label"
                          bindValue="value"
                          slot="input"
                        >
                          <ng-template ng-label-tmp let-item="item">
                            <ng-container [ngTemplateOutlet]="typesTemplate" [ngTemplateOutletContext]="{ item: item }"></ng-container>
                          </ng-template>
                          <ng-template ng-option-tmp let-item="item">
                            <ng-container [ngTemplateOutlet]="typesTemplate" [ngTemplateOutletContext]="{ item: item }"></ng-container>
                          </ng-template>
                          <ng-template #typesTemplate let-item="item">
                            <eworkbench-dmp-status [status]="item.value"></eworkbench-dmp-status>
                          </ng-template>
                        </ng-select>
                      </eworkbench-form-input>
                    </div>
                    <div class="mb-4">
                      <eworkbench-form-input
                        for="projects"
                        [label]="t('dmp.details.projects.label')"
                        [loading]="loading"
                        [onSubmit]="refreshResetValue"
                      >
                        <ng-select
                          class="ewb-select"
                          formControlName="projects"
                          labelForId="projects"
                          name="projects"
                          [placeholder]="t('dmp.details.projects.placeholder')"
                          [multiple]="true"
                          [typeahead]="projectInput$"
                          [items]="projects"
                          groupBy="is_favourite"
                          bindLabel="name"
                          bindValue="pk"
                          slot="input"
                        >
                          <ng-template ng-label-tmp let-item="item" let-clear="clear">
                            {{ item.name }}
                            <span class="ng-value-icon left" (click)="clear(item)" aria-hidden="true">Ã—</span>
                          </ng-template>
                          <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                            <eworkbench-icon className="wb-favorite-3" class="favorite-icon" *ngIf="item.is_favourite"></eworkbench-icon>
                            <span [ngOptionHighlight]="search">{{ item.name }}</span>
                          </ng-template>
                          <ng-template ng-optgroup-tmp let-item="item">
                            <ng-container *ngIf="item.is_favourite">{{ t('formInput.select.optgroup.favorite') }}</ng-container>
                            <ng-container *ngIf="!item.is_favourite">{{ t('formInput.select.optgroup.other') }}</ng-container>
                          </ng-template>
                          <ng-template ng-notfound-tmp>
                            <div class="ng-option">{{ t('formInput.select.noMatch') }}</div>
                          </ng-template>
                        </ng-select>
                      </eworkbench-form-input>
                    </div>
                    <div class="mb-4">
                      <label for="created-by">{{ t('dmp.details.createdBy.label') }}</label>
                      <div class="flex items-center space-x-1">
                        <eworkbench-user-details
                          id="created-by"
                          class="inline-block"
                          [user]="initialState?.created_by"
                        ></eworkbench-user-details>
                        <span> | </span>
                        <span id="created-at">{{ initialState?.created_at | formatDate }}</span>
                      </div>
                    </div>
                    <div class="mb-4">
                      <label for="last-modified-by">{{ t('dmp.details.lastModifiedBy.label') }}</label>
                      <div class="flex items-center space-x-1">
                        <eworkbench-user-details id="last-modified-by" class="inline-block" [user]="initialState?.last_modified_by">
                        </eworkbench-user-details>
                        <span> | </span>
                        <span id="last-modified-at">{{ initialState?.last_modified_at | formatDate }}</span>
                      </div>
                    </div>
                  </ng-container>
                </eworkbench-details-collapse-element>

                <eworkbench-details-collapse-element [labelText]="t('dmp.details.element.metadata')">
                  <ng-container slot="body">
                    <div class="mb-4">
                      <eworkbench-metadata
                        [selectedParameters]="initialState?.metadata ?? []"
                        [editable]="privileges?.edit"
                        [loading]="loading"
                        [refresh]="refreshMetadata"
                        (changed)="onUpdateMetadata($event)"
                      ></eworkbench-metadata>
                    </div>
                  </ng-container>
                </eworkbench-details-collapse-element>
              </div>
              <div>
                <eworkbench-details-collapse-element [labelText]="t('dmp.details.element.links')">
                  <ng-container slot="actions">
                    <eworkbench-link
                      [baseModel]="initialState"
                      [service]="dmpService"
                      (refreshLinkList)="onRefreshLinkList()"
                    ></eworkbench-link>
                  </ng-container>
                  <ng-container slot="body">
                    <eworkbench-link-list [id]="initialState.pk" [service]="dmpService" [refresh]="refreshLinkList"></eworkbench-link-list>
                  </ng-container>
                </eworkbench-details-collapse-element>
              </div>
              <div>
                <eworkbench-details-collapse-element [labelText]="t('dmp.details.element.recentChanges')">
                  <ng-container slot="body">
                    <eworkbench-recent-changes
                      id="recent-changes"
                      [service]="dmpService"
                      [changesId]="id"
                      [refresh]="refreshChanges"
                    ></eworkbench-recent-changes>
                  </ng-container>
                </eworkbench-details-collapse-element>

                <eworkbench-details-collapse-element [labelText]="t('dmp.details.element.versions')">
                  <ng-container slot="body">
                    <eworkbench-versions
                      id="versions"
                      contentType="dmp"
                      [service]="dmpService"
                      [versionId]="id"
                      [lastModifiedAt]="initialState?.last_modified_at"
                      [refresh]="refreshVersions"
                      [editable]="privileges?.edit"
                      (changed)="onVersionChanged()"
                    ></eworkbench-versions>
                  </ng-container>
                </eworkbench-details-collapse-element>

                <eworkbench-details-collapse-element [labelText]="t('dmp.details.element.comments')">
                  <ng-container slot="actions">
                    <button
                      type="button"
                      class="btn ewb-button-regular ewb-button-outline"
                      (click)="onOpenNewCommentModal()"
                      [disabled]="loading"
                    >
                      {{ t('dmp.details.comments.newComment') }}
                    </button>
                  </ng-container>
                  <ng-container slot="body">
                    <eworkbench-comments
                      #comments
                      [service]="dmpService"
                      [id]="id"
                      [contentType]="initialState.content_type"
                    ></eworkbench-comments>
                  </ng-container>
                </eworkbench-details-collapse-element>
              </div></div
          ></eworkbench-overview-collapse-element>

          <div class="border border-tum-border-gray p-4">
            <ng-container *ngIf="initialState?.dmp_form_data?.length">
              <div class="dmp mb-4" *ngFor="let data of initialState?.dmp_form_data; let i = index">
                <div class="dmp-form-data">
                  <label [for]="'formData.' + i">{{ data.name }}</label>
                  <input
                    type="text"
                    class="form-control ewb-input"
                    [formControl]="formData.controls[i]"
                    [id]="'formData.' + i"
                    [name]="'formData.' + i"
                    *ngIf="['TXF', 'NUM'].includes(data.type)"
                  />
                  <eworkbench-wysiwyg-editor
                    [id]="'formData.' + i"
                    [formControl]="formData.controls[i]"
                    *ngIf="data.type === 'TXA'"
                  ></eworkbench-wysiwyg-editor>
                </div>
                <div [innerHTML]="data.infotext | safeHTML"></div>
              </div>
              <div class="dmp form-data-buttons mb-4">
                <div>
                  <button
                    type="button"
                    class="btn ewb-button-big ewb-button-secondary mr-2"
                    [disabled]="loading || form.pristine"
                    (click)="onCancelFormData()"
                  >
                    {{ t('dmp.details.formData.cancel') }}
                  </button>
                  <button type="submit" class="btn ewb-button-big ewb-button-primary" [disabled]="loading || form.pristine">
                    {{ t('dmp.details.formData.save') }}
                  </button>
                </div>
                <div></div>
              </div>
              <div class="dmp form-data-buttons">
                <div>
                  <div class="inline-block mr-2">
                    {{ t('dmp.details.formData.exportAs') }}
                  </div>
                  <button
                    type="button"
                    class="btn ewb-button-big ewb-button-secondary mr-2"
                    [disabled]="loading"
                    (click)="onExport('html')"
                  >
                    {{ t('dmp.details.formData.exportAs.html') }}
                  </button>
                  <button type="button" class="btn ewb-button-big ewb-button-secondary mr-2" [disabled]="loading" (click)="onExport('txt')">
                    {{ t('dmp.details.formData.exportAs.txt') }}
                  </button>
                  <button type="button" class="btn ewb-button-big ewb-button-secondary mr-2" [disabled]="loading" (click)="onExport('xml')">
                    {{ t('dmp.details.formData.exportAs.xml') }}
                  </button>
                  <button type="button" class="btn ewb-button-big ewb-button-secondary" [disabled]="loading" (click)="onExport('pdf')">
                    {{ t('dmp.details.formData.exportAs.pdf') }}
                  </button>
                </div>
                <div></div>
              </div>
            </ng-container>
          </div>
        </form>
      </main>
    </div>
  </ng-container>
</ng-container>
