<!--
  Copyright (C) 2016-2020 TU Muenchen and contributors of ANEXIA Internetdienstleistungs GmbH
  SPDX-License-Identifier: AGPL-3.0-or-later
-->

<ng-container *transloco="let t">
  <eworkbench-header [title]="title">
    <ng-container slot="elements">
      <button class="btn ewb-button-big ewb-button-background" (click)="openNewModal()">
        <eworkbench-icon className="wb-plus-circle"></eworkbench-icon> {{ t('dssContainers.new') }}
      </button>
    </ng-container>
  </eworkbench-header>
</ng-container>

<div [class.filter-sidebar]="!showSidebar" [class.with-sidebar]="showSidebar">
  <main>
    <div class="flex justify-between pb-4 mb-5 border-0 border-b-[3px] border-solid border-tum-border-gray">
      <div></div>
      <eworkbench-table-manage-columns
        class="flex justify-end"
        [columns]="listColumns"
        [defaultColumns]="defaultColumns"
        (columnsChanged)="onColumnsChanged($event)"
      ></eworkbench-table-manage-columns>
    </div>

    <ng-container *transloco="let t">
      <div class="flex justify-between pb-4 mb-5">
        <div class="space-x-2">
          <div *ngIf="!filtersChanged" class="text-sm text-tum-info-color">
            {{ t('filterHeader.noFilters') }}
          </div>

          <div
            *ngIf="searchControl.value"
            class="bg-tum-primary hover:bg-tum-primary-hover text-white py-0.5 px-2.5 rounded-full inline-flex justify-between items-center"
          >
            <span class="text-sm mr-2">{{ t('dssContainers.filter.searchBy.label') }} "{{ searchControl.value }}"</span>
            <button
              type="button"
              class="btn ewb-button-small text-white"
              [tooltip]="t('filterHeader.chip.tooltip.remove')"
              containerClass="tooltip-sm"
              (click)="searchControl.setValue(null)"
            >
              <eworkbench-icon className="wb-remove"></eworkbench-icon>
            </button>
          </div>

          <div
            *ngIf="getFilterSelectedUser"
            class="bg-tum-primary hover:bg-tum-primary-hover text-white py-0.5 px-2.5 rounded-full inline-flex justify-between items-center"
          >
            <span class="text-sm mr-2"
              >{{ t('filterHeader.createdBy') }}{{ ' '
              }}{{ getFilterSelectedUser.pk === currentUser?.pk ? t('filterHeader.createdBy.myself') : '' }}</span
            >
            <eworkbench-user-details
              *ngIf="getFilterSelectedUser.pk !== currentUser?.pk"
              class="inline-block mr-2"
              [user]="getFilterSelectedUser"
              [active]="false"
              [inverted]="true"
              [avatarScale]="0.7"
            ></eworkbench-user-details>
            <button
              type="button"
              class="btn ewb-button-small text-white"
              [tooltip]="t('filterHeader.chip.tooltip.remove')"
              containerClass="tooltip-sm"
              (click)="usersControl.setValue(null)"
            >
              <eworkbench-icon className="wb-remove"></eworkbench-icon>
            </button>
          </div>
        </div>

        <div class="flex items-center space-x-6">
          <button
            *ngIf="filtersChanged"
            type="button"
            class="btn ewb-button-regular ewb-button-additional inline-flex items-center"
            [disabled]="!filtersChanged"
            (click)="onResetFilters()"
          >
            {{ t('filterHeader.resetAll') }}
          </button>
        </div>
      </div>
    </ng-container>

    <eworkbench-collapse-element *ngIf="dssContainerListHowTo" class="mb-8" [labelText]="dssContainerListHowTo?.title" [collapsed]="true">
      <div [innerHTML]="dssContainerListHowTo?.text | safeHTML"></div>
    </eworkbench-collapse-element>

    <eworkbench-table-view
      #tableView
      [columns]="listColumns"
      [service]="dssContainersService"
      [params]="params"
      [skipInit]="showSidebar"
      [sortBy]="sorting?.key"
      [sort]="sorting?.direction"
      (orderChanged)="onColumnsChanged($event)"
      (sortChanged)="onSortChanged($event)"
    ></eworkbench-table-view>
  </main>

  <ng-container *transloco="let t">
    <aside>
      <eworkbench-filter-sidebar
        [activeFilters]="filtersChanged"
        [savedFilters]="savedFilters"
        (resetFilters)="onResetFilters()"
        (saveFilters)="onSaveFilters($event)"
      >
        <div>
          <label for="search-filter" class="text-base font-bold">{{ t('dssContainers.filter.searchBy.label') }}</label>
          <div class="flex mt-4">
            <div class="search-input">
              <div class="input-group search-input-group">
                <input
                  type="text"
                  class="form-control ewb-input"
                  id="search-filter"
                  name="search-filter"
                  [formControl]="searchControl"
                  [placeholder]="t('dssContainers.filter.searchBy.placeholder')"
                />
                <button type="button" class="btn btn-sm bg-transparent clear-input" *ngIf="!searchControl.value">
                  <eworkbench-icon className="wb-search"></eworkbench-icon>
                </button>
                <button
                  type="button"
                  class="btn btn-sm bg-transparent clear-input"
                  (click)="searchControl.patchValue(null)"
                  *ngIf="searchControl.value"
                >
                  <eworkbench-icon className="wb-remove"></eworkbench-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div>
          <label for="users-filter" class="text-base font-bold">{{ t('dssContainers.filter.createdBy.label') }}</label>
          <div class="mt-4">
            <div class="space-y-2">
              <div class="custom-control custom-radio">
                <input
                  type="radio"
                  class="custom-control-input"
                  name="filter-user-radio"
                  id="filter-user-radio-1"
                  [value]="null"
                  [formControl]="usersControl"
                  (change)="onUserFilterRadioAnyone()"
                />
                <label for="filter-user-radio-1" class="custom-control-label font-normal leading-6">{{
                  t('filter-menu.anyone.label')
                }}</label>
              </div>
              <div class="custom-control custom-radio">
                <input
                  type="radio"
                  class="custom-control-input"
                  name="filter-user-radio"
                  id="filter-user-radio-2"
                  [value]="currentUser?.pk"
                  [formControl]="usersControl"
                  (change)="onUserFilterRadioMyself($event.target?.checked)"
                />
                <label for="filter-user-radio-2" class="custom-control-label font-normal leading-6">{{
                  t('filter-menu.myself.label')
                }}</label>
              </div>
              <div class="custom-control custom-radio">
                <input
                  type="radio"
                  class="custom-control-input"
                  name="filter-user-radio"
                  id="filter-user-radio-3"
                  (change)="showUserFilter = $event.target?.checked"
                />
                <label for="filter-user-radio-3" class="custom-control-label font-normal leading-6">{{
                  t('filter-menu.chooseAUser.label')
                }}</label>
              </div>
            </div>
            <div *ngIf="showUserFilter" class="mt-4">
              <ng-select
                #select
                class="ewb-select"
                [formControl]="usersControl"
                labelForId="users-filter"
                name="users-filter"
                [placeholder]="t('dssContainers.filter.users.placeholder')"
                [typeahead]="usersInput$"
                [items]="users"
                bindLabel="username"
                bindValue="pk"
              >
                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                  <div class="flex items-center user-option">
                    <eworkbench-user-details
                      class="inline-block mr-1"
                      [user]="item"
                      [chip]="true"
                      (click)="select.isOpen = false"
                    ></eworkbench-user-details>
                    <span class="sub-text">{{ item.email }}</span>
                  </div>
                </ng-template>

                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                  <div class="user-dropdown-option">
                    <img class="rounded-full mr-2" width="40" [src]="item.userprofile.avatar" [alt]="t('profile.picture')" />
                    <div>
                      <ng-container *ngIf="item?.userprofile.anonymized">
                        <span class="details text-gray-600">{{ t('user.details.anonymizedUser') }}</span>
                      </ng-container>
                      <ng-container *ngIf="!item?.userprofile.anonymized">
                        <ng-container
                          *ngIf="item?.userprofile.first_name && item?.userprofile.last_name; then userTemplate; else usernameTemplate"
                        ></ng-container>
                      </ng-container>

                      <ng-template #userTemplate>
                        <span [ngOptionHighlight]="search">{{ item?.userprofile.first_name }} {{ item?.userprofile.last_name }}</span>
                      </ng-template>
                      <ng-template #usernameTemplate>
                        <span [ngOptionHighlight]="search">{{ item?.username }}</span>
                      </ng-template>

                      <div class="sub-text" [ngOptionHighlight]="search">{{ item.email }}</div>
                    </div>
                  </div>
                </ng-template>
              </ng-select>
            </div>
          </div>
        </div>
      </eworkbench-filter-sidebar>
    </aside>
  </ng-container>
</div>

<ng-template #nameCellTemplate let-row>
  <div ellipsis [tooltip]="row.name" containerClass="tooltip-sm" [delay]="500">
    <a [routerLink]="['/dsscontainers', row.pk]">{{ row.name }}</a>
  </div>
</ng-template>
<ng-template #pathCellTemplate let-row>
  {{ row.path }}
</ng-template>
<ng-template #readWriteSettingCellTemplate let-row>
  <eworkbench-dss-read-write-setting [readWriteSetting]="row.read_write_setting"></eworkbench-dss-read-write-setting>
</ng-template>
<ng-template #importOptionCellTemplate let-row>
  <eworkbench-dss-import-option [importOption]="row.import_option"></eworkbench-dss-import-option>
</ng-template>
<ng-template #createdAtCellTemplate let-row>
  <div class="whitespace-nowrap">
    {{ row.created_at | formatDate }}
  </div>
</ng-template>
<ng-template #createdByCellTemplate let-row>
  <eworkbench-user-details [user]="row.created_by"></eworkbench-user-details>
</ng-template>
<ng-template #lastModifiedAtCellTemplate let-row>
  <div class="whitespace-nowrap">
    {{ row.last_modified_at | formatDate }}
  </div>
</ng-template>
<ng-template #lastModifiedByCellTemplate let-row>
  <eworkbench-user-details [user]="row.last_modified_by"></eworkbench-user-details>
</ng-template>
