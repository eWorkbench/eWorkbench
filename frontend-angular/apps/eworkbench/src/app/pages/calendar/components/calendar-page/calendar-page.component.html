<!--
  Copyright (C) 2016-2020 TU Muenchen and contributors of ANEXIA Internetdienstleistungs GmbH
  SPDX-License-Identifier: AGPL-3.0-or-later
-->

<ng-container *transloco="let t">
  <eworkbench-header [title]="title">
    <ng-container slot="search">
      <div class="flex items-center">
        <div class="search-input mr-2">
          <ng-select
            class="ewb-select"
            [formControl]="projectsControl"
            labelForId="projects-header"
            name="projects-header"
            [placeholder]="t('calendar.header.projects.placeholder')"
            [typeahead]="projectsInput$"
            [items]="projects"
            groupBy="is_favourite"
            bindLabel="name"
            bindValue="pk"
          >
            <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
              <eworkbench-icon className="wb-favorite-3" class="favorite-icon" *ngIf="item.is_favourite"></eworkbench-icon>
              <span [ngOptionHighlight]="search">{{ item.name }}</span>
            </ng-template>
            <ng-template ng-optgroup-tmp let-item="item">
              <ng-container *ngIf="item.is_favourite">{{ t('formInput.select.optgroup.favorite') }}</ng-container>
              <ng-container *ngIf="!item.is_favourite">{{ t('formInput.select.optgroup.other') }}</ng-container>
            </ng-template>
            <ng-template ng-notfound-tmp>
              <div class="ng-option">{{ t('formInput.select.noMatch') }}</div>
            </ng-template>
          </ng-select>
        </div>

        <div class="search-input mr-2">
          <div class="input-group search-input-group">
            <input
              type="text"
              class="form-control ewb-input"
              id="search-header"
              name="search-header"
              [formControl]="searchControl"
              [placeholder]="t('calendar.header.search.placeholder')"
            />
            <button type="button" class="btn btn-sm bg-transparent clear-input" *ngIf="!searchControl.value">
              <eworkbench-icon className="wb-search"></eworkbench-icon>
            </button>
            <button
              type="button"
              class="btn btn-sm bg-transparent clear-input"
              (click)="searchControl.patchValue(null)"
              *ngIf="searchControl.value"
            >
              <eworkbench-icon className="wb-remove"></eworkbench-icon>
            </button>
          </div>
        </div>

        <div class="filter-button" dropdown container="body" placement="bottom right" [insideClick]="true">
          <button
            type="button"
            id="calendar-filter-button"
            class="btn ewb-button-big ewb-button-background"
            aria-controls="calendar-filter-dropdown-menu"
            dropdownToggle
          >
            <eworkbench-icon className="wb-filter"></eworkbench-icon>
            {{ t('calendar.header.filterByType') }}
          </button>
          <ul
            id="calendar-filter-dropdown-menu"
            *dropdownMenu
            class="dropdown-menu dropdown-menu-right calendar-filter-dropdown-menu"
            role="menu"
            aria-labelledby="calendar-filter-button"
          >
            <li class="btn ewb-button-regular font-normal w-full text-left menu-item-button" role="menuitem">
              <div class="custom-control custom-checkbox">
                <input
                  type="checkbox"
                  id="my-appointments-filter"
                  name="my-appointments-filter"
                  class="custom-control-input"
                  [formControl]="myAppointmentsCheckbox"
                />
                <label class="custom-control-label w-full font-normal" for="my-appointments-filter">
                  {{ t('calendar.header.filterByType.myAppointments.label') }}
                </label>
              </div>
            </li>
            <li class="btn ewb-button-regular font-normal w-full text-left menu-item-button" role="menuitem">
              <div class="custom-control custom-checkbox">
                <input
                  type="checkbox"
                  id="my-tasks-filter"
                  name="my-tasks-filter"
                  class="custom-control-input"
                  [formControl]="myTasksCheckbox"
                />
                <label class="custom-control-label w-full font-normal" for="my-tasks-filter">
                  {{ t('calendar.header.filterByType.myTasks.label') }}
                </label>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </ng-container>

    <ng-container slot="elements">
      <button class="btn ewb-button-big ewb-button-background mr-2" (click)="onOpenPrivilegesModal()">
        <eworkbench-icon className="wb-unlock"></eworkbench-icon> {{ t('calendar.calendarAccessPrivileges') }}
      </button>
      <button class="btn ewb-button-big ewb-button-background" (click)="openNewModal()">
        <eworkbench-icon className="wb-plus-circle"></eworkbench-icon> {{ t('calendar.new') }}
      </button>
    </ng-container>

    <ng-container slot="appendix">
      <div class="header-appendix">
        <div class="mt-2">
          <div class="search-input-lg">
            <ng-select
              #select
              class="ewb-select"
              [formControl]="usersControl"
              labelForId="users-header"
              name="users"
              [placeholder]="t('calendar.header.users.placeholder')"
              [typeahead]="usersInput$"
              [items]="users"
              bindLabel="username"
              bindValue="pk"
              (change)="onSelectUser($event)"
            >
              <ng-template ng-label-tmp let-item="item" let-clear="clear">
                <div class="flex items-center user-option">
                  <eworkbench-user-details
                    class="inline-block mr-1"
                    [user]="item"
                    [chip]="true"
                    (click)="select.isOpen = false"
                  ></eworkbench-user-details>
                  <span class="sub-text">{{ item.email }}</span>
                </div>
              </ng-template>

              <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                <eworkbench-user-details-dropdown
                  class="inline-block mr-1"
                  [user]="item"
                  [search]="search"
                ></eworkbench-user-details-dropdown>
              </ng-template>
            </ng-select>
          </div>
          <ng-select
            #select
            class="ewb-select flex-fill"
            [multiple]="true"
            [formControl]="selectedUsersControl"
            name="selected-users"
            [items]="selectedUsers"
            bindLabel="username"
            bindValue="pk"
            *ngIf="selectedUsers.length"
          >
            <ng-template ng-label-tmp let-item="item" let-clear="clear">
              <div class="flex items-center user-option">
                <eworkbench-user-details
                  class="inline-block mr-1"
                  [user]="item"
                  [chip]="true"
                  (click)="select.isOpen = false"
                ></eworkbench-user-details>
                <span
                  class="ng-value-icon left rounded-full"
                  aria-hidden="true"
                  [style.background]="item.color"
                  [style.height]="'20px'"
                  [style.width]="'20px'"
                ></span>
              </div>
            </ng-template>
            <ng-template ng-option-tmp let-item="item" let-search="searchTerm" let-item$="item$" let-index="index">
              <div class="user-dropdown-option">
                <eworkbench-user-details-dropdown class="inline-block mr-1" [user]="item"></eworkbench-user-details-dropdown>
                <span
                  class="ng-value-icon align-self-center text-right text-lg ml-1"
                  (click)="onRemoveSelectedUser(item)"
                  aria-hidden="true"
                  >×</span
                >
              </div>
            </ng-template>
          </ng-select>
        </div>
        <div class="mt-2">
          <div class="search-input-lg">
            <ng-select
              #select
              class="ewb-select"
              [formControl]="resourcesControl"
              labelForId="resources-header"
              name="resources"
              [placeholder]="t('calendar.header.resources.placeholder')"
              [typeahead]="resourcesInput$"
              [items]="resources"
              groupBy="is_favourite"
              bindLabel="display"
              bindValue="pk"
              (change)="onSelectResource($event)"
            >
              <ng-template ng-label-tmp let-item="item">{{ item.display }} ({{ item.location }})</ng-template>
              <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                <eworkbench-icon className="wb-favorite-3" class="favorite-icon" *ngIf="item.is_favourite"></eworkbench-icon>
                <span [ngOptionHighlight]="search">{{ item.display }}</span>
                <div [ngOptionHighlight]="search" class="sub-text">{{ item.location }}</div>
              </ng-template>
              <ng-template ng-optgroup-tmp let-item="item">
                <ng-container *ngIf="item.is_favourite">{{ t('formInput.select.optgroup.favorite') }}</ng-container>
                <ng-container *ngIf="!item.is_favourite">{{ t('formInput.select.optgroup.other') }}</ng-container>
              </ng-template>
              <ng-template ng-notfound-tmp>
                <div class="ng-option">{{ t('formInput.select.noMatch') }}</div>
              </ng-template>
            </ng-select>
          </div>
          <ng-select
            #select
            class="ewb-select flex-fill"
            [multiple]="true"
            [formControl]="selectedResourcesControl"
            name="selected-resources"
            [items]="selectedResources"
            bindLabel="display"
            bindValue="pk"
            *ngIf="selectedResources.length"
          >
            <ng-template ng-label-tmp let-item="item" let-clear="clear">
              {{ item.display }}
              <span
                class="ng-value-icon left ml-1 rounded-full"
                aria-hidden="true"
                [style.background]="item.color"
                [style.width]="'20px'"
              ></span>
            </ng-template>
            <ng-template ng-option-tmp let-item="item">
              {{ item.display }}
              <span class="ng-value-icon left ml-1" (click)="onRemoveSelectedResource(item)" aria-hidden="true">×</span>
            </ng-template>
          </ng-select>
        </div>
      </div>
    </ng-container>
  </eworkbench-header>
</ng-container>

<div [class.with-sidebar]="showSidebar">
  <aside *ngIf="showSidebar">
    <eworkbench-project-sidebar [sidebarItem]="sidebarItem"></eworkbench-project-sidebar>
  </aside>
  <main>
    <eworkbench-calendar
      #calendar
      [headerToolbar]="{ left: 'timeGridWeek,dayGridMonth', center: 'title', right: 'today prev,next export' }"
      [customButtons]="customButtons"
      initialView="timeGridWeek"
      (datesSet)="onDatesSet($event)"
      (selected)="onSelect($event)"
      (eventClicked)="onEventClicked($event)"
      (eventDidMount)="onEventDidMount($event)"
      (eventWillUnmount)="onEventWillUnmount($event)"
      (eventMouseEnter)="onEventMouseEnter($event)"
      (eventMouseLeave)="onEventMouseLeave($event)"
    ></eworkbench-calendar>
  </main>
</div>

<ng-template #popoverTemplate let-event="event">
  <ng-container *transloco="let t">
    <ng-container *ngIf="!event.allDay">
      <div>
        <strong>{{ t('appointment.details.startDate.label') }}:</strong>
        {{ event.startStr | formatDate }}
      </div>
      <div>
        <strong>{{ t('appointment.details.endDate.label') }}:</strong>
        {{ event.endStr | formatDate }}
      </div>
    </ng-container>
    <ng-container *ngIf="event.allDay">
      <strong>{{ t('calendar.popover.date.label') }}:</strong>
      {{ event.startStr | formatDate: false }}
    </ng-container>
    <div *ngIf="event.extendedProps?.attending_users?.length">
      <strong class="mr-1">{{ t('appointment.details.attendees.label') }}:</strong>
      <ng-container *ngFor="let user of event.extendedProps.attending_users; let last = last">
        <eworkbench-user-details class="inline-block" [user]="user"></eworkbench-user-details><span *ngIf="!last">, </span>
      </ng-container>
    </div>
    <div *ngIf="event.extendedProps?.resource">
      <strong>{{ t('appointment.details.resource.label') }}:</strong>
      {{ event.extendedProps.resource.display }}
    </div>
  </ng-container>
</ng-template>
